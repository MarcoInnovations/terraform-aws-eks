# A Terraform module to deploy an AWS EKS Cluster

This module will create an **[AWS EKS](https://docs.aws.amazon.com/eks/index.html)** cluster and is a terraform wrapper for the official **[AWS terraform EKS module](https://registry.terraform.io/modules/terraform-aws-modules/eks/aws)** to provide ease of deployment with environments that may need use of a proxy for connectivity in a private VPC.

This EKS module is referencing the github EKS module maintained by terraform and is available **[here](https://github.com/terraform-aws-modules/terraform-aws-eks)**.

The following tools are required for deployment (the versions are needed to support AWS EKS functionality):  

  * **kubectl** (version 1.13+)  
  * **jq**  
  * **aws-iam-authenticator**  
  * **awscli** (version 1.16+)


## Usage

#### Two examples have been provided.  
  * **desktop\_private\_VPC** - will deploy an EKS cluster from your desktop in the provided account;  
  * **ec2\_node\_private\_VPC** - will deploy an EKS cluster from an EC2 instance in the provided account.

Depending on your need, go to the appropriate folder and run:  

  * terraform init && terraform apply  


## Inputs

#### List of all variables used:  




| Name | Description | Type | Default | Required |
|------|-------------|:----:|:-----:|:-----:|
| product\_domain\_name | Name of your product-domain (used in a tag) | string | n/a | no |
| environment\_type | Environment where this deployment runs in (used in a tag) | string | n/a | no|
| cluster\_prefix | Name prefix of your EKS cluster | string | n/a | yes |
| desired\_worker\_nodes | Desired amount of worker nodes (needs to be => then minimum worker nodes) | string | `"1"` | no |
| http\_proxy | IP[:PORT] address and  port of HTTP proxy for your environment | string | `""` | no |
| key\_name | Key pair to use to access the instance created by the ASG/LC | string | n/a | yes |
| max\_worker\_nodes | Maximum amount of worker nodes to spin up | string | `"6"` | no |
| min\_worker\_nodes | Minimum amount of worker nodes (needs to be <= then desired worker nodes). | string | `"1"` | no |
| no\_proxy | Endpoint that do not need to go through proxy | string | `""` | no |
| outputs\_directory | The local folder path to store output files. Must end with '/' . | string | `"./output/"` | no |
| private\_subnets | All private subnets in your VPC | list | n/a | yes |
| region | AWS region | string | n/a | yes |
| tags | Map of tags to apply to deployed resources | map | `<map>` | no |
| vpc\_id | ID of VPC to deploy the cluster | string | n/a | yes |
| worker\_node\_instance\_type |  | string | `"m4.large"` | no |


 See "Notes" for an example tfvars file.


## Notes
User controlable variables:  

*  **region**   
*  **vpc\_id**  
*  **private\_subnets**  
*  **cluster\_prefix**  
*  **http\_proxy**  
*  **no\_proxy**  
*  **product\_domain_name**  
*  **environment\_type**  
*  **key\_name**  

As an example, here is a terraform.auto.tfvars file which allows the EKS cluster to be created (put this file in the folder you run terraform from and it will pick up all the needed info):

|Variable|Value|	explanation|
|------|-------------|----|
|**region** | "us-east-1"|the region you want to deploy the EKS.|
|**vpc_id** | "vpc-12345678"|your VPC ID to deploy the EKS to. |
|**private\_subnets** |"["subnet-12345678", "subnet-23456789", "subnet-34567890"]"|your private subnets in the VPC to use for the EKS, in a list format.|
|**cluster\_prefix** | "my-eks" | the unique name for your EKS cluster.|
|**http\_proxy** | "http://1.1.1.1:80"|your proxy in the transit account.| 
|**no\_proxy** | "localhost,127.0.0.1,10.0.0.0/8,172.16.0.0/12,.internal"|the endpoint(s) that should not use the above described proxy. |
|**product\_domain\_name** | "ec2\_node\_private\_vpc"| the name of your product.  This is used as a tag.|
|**environment\_type** | "dev"|environment this deployment lives in. |
|**key\_name** | "my-key-pair"| existing key-pair to be able to connect to the nodes.|  

Please provide the vars file in this format: variable_name = "Variable Value".  
If any of the above information is not provided in a 'tfvars' file, terraform will ask for this information. 

## Outputs


In the folder **./outputs**, several files are created by terraform.  **kubeconfig\_EKS\_NAME** can be used by the operator to access the EKS cluster or to deploy applications.  The other files are not needed during normal operation but will provide insight in how the cluster and nodes are configured.

Also when the terraform script is finished, it will output the following to the console:  

| Name | Description |
|------|-------------|
| **cluster\_endpoint** | Endpoint for EKS control plane. |
| **config\_map\_aws\_auth** | used during the creation of the EKS cluster |
| **kubeconfig** | kubectl config as generated by the module. |
